<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CityShare — Dashboard</title>
  <!-- NO external CSS; keep it self-contained -->
  <style>
    :root {
      --bg: #000;
      --fg: #eaeaea;
      --muted: #9aa0a6;
      --card: #121212;
      --accent: #dc3545;
      --chip: #1f1f1f;
      --chip-border: #2a2a2a;
      --link: #fff;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
        margin: 0;
        min-height: 100vh;
        background: url("images/background.png") no-repeat center center fixed;
        background-size: cover;
        color: var(--fg);
        font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
        position: relative;
        overflow-x: hidden;
    }

    body::before {
        content: "";
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.55); /* ← darkness intensity */
        backdrop-filter: blur(1px);      /* slightly softens bright spots */
        z-index: -1;
    }

    /* Header / search */
    .header {
      position: sticky; top: 0; z-index: 10;
      background: rgba(0,0,0,.9); backdrop-filter: blur(4px);
      border-bottom: 1px solid #111; padding: .75rem 1rem;
    }
    .wrap { max-width: 1100px; margin: 0 auto; }
    .brand { font-weight: 700; letter-spacing:.2px; margin-bottom: .5rem; }
    .search-row {
      display: grid; grid-template-columns: 1fr 140px 160px auto; gap: .5rem;
    }
    .input, .select, .btn {
      height: 42px; border-radius: 8px; border: 1px solid #222; background:#0c0c0c; color:var(--fg);
      padding: 0 .75rem; outline: none;
    }
    .input::placeholder { color: #666; }
    .btn {
      background: var(--accent); border: none; font-weight: 700; cursor: pointer;
    }
    .btn:hover { filter: brightness(1.05); }

    /* Content */
    main { padding: 1rem; }
    h2 { font-size: 1rem; color: var(--muted); font-weight: 600; margin: .5rem 0 1rem; }

    /* Grid */
    .grid {
      display: grid; gap: 1rem;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    }
    .card {
        background: rgba(0, 120, 150, 0.35);
        border: 1px solid rgba(0, 255, 255, 0.25);
        border-radius: 12px;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }

    .thumb {
      width: 100%; height: 150px; object-fit: cover; border-radius: 8px; background:#0a0a0a;
      display: block; margin-bottom: .5rem;
    }
    .title { font-weight: 700; margin: .25rem 0; }
    .desc  { color: var(--muted); font-size: .9rem; min-height: 2.6em; }
    .chips { margin: .5rem 0; display: flex; flex-wrap: wrap; gap: .35rem; }
    .chip {
      display: inline-flex; align-items:center; gap:.35rem;
      background: var(--chip); border:1px solid var(--chip-border);
      color: var(--fg); font-size: .75rem; padding: .2rem .5rem; border-radius: 999px;
    }
    .meta  { color: #7c7c7c; font-size: .8rem; margin-bottom: .4rem; }
    .link  { display:inline-block; text-decoration: none; background: var(--accent);
             color: var(--link); padding: .45rem .75rem; border-radius: 8px; font-weight: 700; }

    /* Small screens: stack selects under input */
    @media (max-width: 720px){
      .search-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="wrap">
      <div class="brand">CityShare</div>
      <form id="searchForm" class="search-row">
        <input id="q" name="q" class="input" type="text" placeholder="Search items… (chair, jacket, drill)"/>
        <select id="type" name="type" class="select">
          <option value="">All types</option>
          <option value="sell">Sell</option>
          <option value="donate">Donate</option>
          <option value="borrow">Borrow</option>
        </select>
        <select id="category" name="category" class="select">
          <option value="">All categories</option>
          <option>clothing</option><option>tools</option><option>furniture</option>
          <option>electronics</option><option>books</option><option>toys</option>
          <option>kitchen</option><option>sports</option><option>kids</option><option>other</option>
        </select>
        <button class="btn" type="submit">Search</button>
      </form>
    </div>
  </header>

  <main class="wrap">
    <h2>Recent Listings</h2>
    <div id="listings" class="grid" aria-live="polite"></div>
  </main>

  <script>
    function priceLabel(row){
      if (row.type === 'sell') return row.price_cents != null ? `$${(row.price_cents/100).toFixed(2)}` : '$0.00';
      if (row.type === 'donate') return 'Free';
      return 'Borrow';
    }
    function imgSrc(url){ return (url && url.trim()) ? url : '/images/Logo.png'; }

    function chip(text){ return `<span class="chip">${text}</span>`; }

    async function loadListings(params={}){
      const url = new URL('/api/listings', window.location.origin);
      Object.entries(params).forEach(([k,v]) => { if (v) url.searchParams.set(k, v); });
      const res = await fetch(url);
      if (!res.ok) { console.error('Failed to load listings'); return; }
      const data = await res.json();

      const box = document.getElementById('listings');
      if (!Array.isArray(data) || data.length === 0) {
        box.innerHTML = '<div class="meta">No results.</div>';
        return;
      }

      box.innerHTML = data.map(row => {
        return `
          <article class="card">
            <img class="thumb" src="${imgSrc(row.image_url)}" alt="">
            <div class="title">${row.item_name ?? 'Untitled'}</div>
            <div class="desc">${(row.description ?? '').slice(0,140)}</div>
            <div class="chips">
              ${chip(row.category ?? 'other')}
              ${chip(row.type ?? '—')}
              ${chip(row.usage_status ?? 'available')}
              ${chip(priceLabel(row))}
            </div>
            <div class="meta">#${row.listing_number ?? row.id}</div>
            <a class="link" href="/listings/${row.id}">View</a>
          </article>
        `;
      }).join('');
    }

    document.getElementById('searchForm').addEventListener('submit', (e) => {
      e.preventDefault();
      loadListings({
        q: document.getElementById('q').value.trim(),
        type: document.getElementById('type').value,
        category: document.getElementById('category').value,
        limit: 24
      });
    });

    // Initial load: most recent 12
    loadListings({ limit: 12 });
  </script>
</body>
</html>
